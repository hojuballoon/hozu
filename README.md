# 保津川川柳
中学生の頃にプログラミングをはじめて一番最初に作った記念すべき処女作。

いかにも中学生が書いたような雑な絵を背景に怪しげなBGMが流れ、一句ボタンを押すとランダムで川柳が生成されます。

ほとんどでたらめですが結構意味の通る川柳ができたりもします。

当初はHSP2.55を使っておふざけのつもりで作りましたが、C言語を学ぶにあたってC言語で書き直したり新しく身に着けた技術をどんどん試しているうちに無駄に完成度の高いソフトになってしまいました。

# このソフトの技術的特色

実行ファイルのサイズは背景画像を含めてたったの19kBです。おふざけで作った何の役にも立たないソフトですから、少しでもディスクの中で邪魔にならないように小さく作っています。

小さくするために次のような努力と工夫をしています。

(1) Win32APIで作る

当時は子どもでしたのでVisual C++なんか買えるお金がありません。
そこで無料のBorland C++ Compilerを使ってC言語の勉強を始めましたが、VCLやMFCみたいな気の利いたものは付いてませんのでWin32APIだけでGUIを作る必要がありました。
何度も挫折しそうになりましたが、保津川川柳をCで書き直す過程でWindowsプログラミングの極意を極めることができました。
現在でもWindowsソフトを作る時は同じ方法で作っています。（というかそれしか知らない）

(2) Cの標準関数を使わない

C言語にはprintfやfopenといった標準関数がありますが、Win32APIを勉強するうちにこれらはWin32APIで代用できることを知りました。
printfはWriteFile、fopenはCreateFile、mallocはHeapAllocと言った具合に標準関数と同等の機能を持つAPI関数があります。
というか標準関数自体がそのラッパーに過ぎず、内部でこれらのAPIを呼んでるわけですから直接呼び出したほうがファイルサイズは小さくなりオーバーヘッドが減って速くなります。
本ソフトウェアはprintfもfopenも使ってませんが、memsetに相当するZeroMemoryとmemcpyに相当するMoveMemoryを使っています。
ところがこれが曲者で、Windows SDKのヘッダファイルはZeroMemoryをmemsetに、MoveMemoryに結びつけてしまいます。
そこで#undefしてからDLLのインポート関数として再定義し直すことで徹底的に標準関数を排除しました。
それにしても、わざわざAPI関数を呼び出そうとしてるのになぜ標準関数に結びつけようとするのでしょうか。よくわからない仕様です。

(3) スタートアップルーチンも自前

標準関数にはスタートアップルーチンという、ソフトが起動して最初に実行されるプログラムが含まれています。
したがって標準関数を排除するとなればスタートアップルーチンもAPIで書き直す必要があります。
これに関しては有志による作例がネットに転がっていましたのでそちらを利用させて頂きました。
tiny.cがそれにあたります。

(4) GIF画像をOLEで表示

本ソフトウェアを作った当初はBMP形式で画像を実行ファイルに含めていたため実行ファイルがとても重かったです。
軽量なGIF画像を扱うことができれば実行ファイルを軽くできるという考えがあったものの、GIFはUNISYS社の特許が残っていたため自作ソフトに組み込むには問題がありました。
ところが2004年6月にGIFの特許が切れたため気兼ねなくGIF画像を自作ソフトに含められるようになりました。
GIF画像を表示する良い方法がないか調べたところ、OLEというAPIの仲間みたいなものを使うと比較的簡潔なプログラムでGIF画像を扱えることを知りました。
画像を表示するルーチンをOLEで実装したことで実行ファイルを大幅に軽くすることに成功しました。

(5) 乱数は暗号用APIで生成

ランダムで川柳を表示するには乱数が必要ですが、標準関数を使わないとなればこれもまた難しい問題です。
しかしながら、他の標準関数がそうであるように乱数を作るAPI関数も存在しています。それはRtlGenRandomです。
この関数は暗号やセキュリティ関係のadvapi32.dllに含まれてますが、あまりにマニアックすぎるのか内部ではSystemFunction036という名前になっていてそのままでは呼び出すことができません。
そこで動的にadvapi32.dllを読み込んでSystemFunction036を叩くように実装しました。
この関数が生成する乱数は暗号用に使えるほど強力なもので、randなんかよりずっと高品質な乱数を出してくれます。
これを作ったMicrosoftの中の人も、まさか川柳に使われるとは思ってもなかったでしょう。

# 軽いソフトを作る参考に

本ソフトウェアには私がプログラミングの勉強をしてきた軌跡と執念深き実行ファイル軽量化の涙ぐましい努力が凝縮されています。
軽いソフトを作りたい人にとっては大いに参考にできる点が多々あると思いますので、そういう形でお役に立てると幸いです。

著作権は放棄してませんので、保津川川柳をちょっと改造して荒川川柳を作って再配布するようなことはご遠慮ください。
ただし原型がなくなるほどいじくった場合はこの限りではありません。

画像を表示するルーチンなど、部分的にはどんどんコピペして使ってもらって結構です。<s>というか私もやってるし。</s>
tiny.cはネットで拾ってきたものですが、内容でググってみると同じコードがあちこちで使われているようですので自由に使って問題ないでしょう。
